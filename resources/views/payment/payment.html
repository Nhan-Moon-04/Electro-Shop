<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>N·∫°p Ti·ªÅn</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4">

    <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
        <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">üíµ Select payment method</h1>

        <!-- Select payment method -->
        <div class="flex justify-center gap-4 mb-6">
            <button onclick="showMethod('vnd')"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">VNƒê</button>
            <button onclick="showMethod('crypto')"
                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">Crypto</button>
        </div>

        <!-- PH·∫¶N VNƒê -->
        <div id="vnd-section" class="hidden">
            <h2 class="text-xl font-bold text-green-600 mb-4 text-center">Chuy·ªÉn Kho·∫£n VNƒê</h2>
            <div class="text-center text-gray-800 mb-2">
                Ng√¢n h√†ng: <strong>VietinBank</strong><br />
                Ch·ªß t√†i kho·∫£n: <strong>Nguy·ªÖn Thi·ªán Nh√¢n</strong><br />
                STK: <span id="stk">100610161104</span>
                <button onclick="copyText('stk')"
                    class="ml-2 px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300">üìã Copy</button>
            </div>

            <!-- Nh·∫≠p s·ªë ti·ªÅn -->
            <div class="mb-4">
                <label for="amount" class="block text-sm font-medium text-gray-700">Nh·∫≠p s·ªë ti·ªÅn (VNƒê):</label>
                <input type="number" id="amount" class="mt-1 block w-full border rounded p-2" placeholder="VD: 100000"
                    oninput="updateQR()" />
            </div>

            <!-- M√£ QR -->
            <div class="text-center">
                <img id="qrImage"
                    src="https://img.vietqr.io/image/mbbank-888802888803-compact2.png?amount=0&addInfo=NAP%20TIEN"
                    class="mx-auto rounded-lg border shadow-md" width="200" alt="QR chuy·ªÉn kho·∫£n">
            </div>

            <div class="text-center mt-4">
                <button onclick="createAndGoToPayment('vnd')"
                    class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-xl">T√¥i ƒë√£ chuy·ªÉn kho·∫£n / Thanh
                    to√°n</button>
            </div>
        </div>

        <!-- PH·∫¶N CRYPTO -->
        <div id="crypto-section" class="hidden">
            <h2 class="text-xl font-bold text-purple-600 mb-4 text-center">Deposit With Crypto</h2>

            <div class="mb-3">
                <label for="cryptoSelect" class="block text-sm font-medium text-gray-700">Select coin type:</label>
                <select id="cryptoSelect" class="mt-1 block w-full border rounded p-2" onchange="updateCryptoQR()">
                    <option value="eth">Ethereum (ERC20)</option>
                    <option value="trc20">Tron (TRC20)</option>
                </select>
            </div>

            <div class="text-center mb-2">
                <p class="text-gray-800">Wallet address:</p>
                <div class="flex justify-center items-center gap-2 mt-1">
                    <span id="crypto-address"
                        class="font-mono text-sm">0xCEc09b84bd5254b8dB35FA126DF5699ecC977728</span>
                    <button onclick="copyCrypto()" class="bg-gray-200 hover:bg-gray-300 text-sm px-2 py-1 rounded">üìã
                        Copy</button>
                </div>
                <p id="crypto-msg" class="text-green-600 text-sm mt-1 hidden">Please hold and copy!!!</p>
            </div>

            <div class="flex justify-center">

            </div>

            <div class="text-center mt-4">
                <button onclick="createAndGoToPayment('crypto')"
                    class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-xl">Done / Thanh to√°n</button>
            </div>
        </div>
    </div>

    <script>
        function showMethod(method) {
            document.getElementById('vnd-section').style.display = (method === 'vnd') ? 'block' : 'none';
            document.getElementById('crypto-section').style.display = (method === 'crypto') ? 'block' : 'none';
        }

        function updateQR() {
            const amount = document.getElementById("amount").value || 0;
            const qr = document.getElementById("qrImage");
            qr.src = `https://img.vietqr.io/image/mbbank-888802888803-compact2.png?amount=${amount}&addInfo=NAP%20TIEN`;
        }

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text);
            alert("‚úÖ Please hold and copy!!!");
        }

        async function createAndGoToPayment(method) {
            // Minimal demo payload: single item purchase with placeholder customer_id=1
            const amount = document.getElementById('amount') ? parseInt(document.getElementById('amount').value || 0) : 0;
            // For demo we try to map to a product_variant_id if available on the page via data attribute
            const variantId = window.__demo_variant_id || 44; // fallback to 44 which exists in SQL dump

            const payload = {
                product_variant_id: variantId,
                quantity: 1,
                customer_id: 1,
                order_name: 'Kh√°ch l·∫ª',
                order_phone: '0000000000',
                order_delivery_address: 'ƒê·ªãa ch·ªâ demo',
                order_note: method === 'vnd' ? 'Thanh to√°n VNƒê' : 'Thanh to√°n Crypto'
            };

            try {
                const res = await fetch('/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.status === 201 && data.order_id) {
                    // redirect to server-rendered payment page where webhook simulation is available
                    window.location.href = '/payment/' + data.order_id;
                } else {
                    alert('Failed to create order: ' + JSON.stringify(data));
                }
            } catch (e) {
                alert('Error creating order: ' + e.message);
            }
        }

        const cryptoAddresses = {
            eth: "0xCEc09b84bd5254b8dB35FA126DF5699ecC977728",
            trc20: "TRTgDJU8eFipdNwD7oBPrPbiNp62C6bdby"
        };

        function updateCryptoQR() {
            const selected = document.getElementById("cryptoSelect").value;
            const address = cryptoAddresses[selected];
            document.getElementById("crypto-address").innerText = address;
            document.getElementById("cryptoQR").src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${address}`;
        }

        function copyCrypto() {
            const text = document.getElementById("crypto-address").innerText;
            navigator.clipboard.writeText(text);
            const msg = document.getElementById("crypto-msg");
            msg.classList.remove("hidden");
            setTimeout(() => msg.classList.add("hidden"), 2000);
        }

        function confirmCrypto() {
            alert("Thank you for sending crypto. The transaction will be processed!");
            setTimeout(() => window.location.href = "/", 2000);
        }
    </script>

</body>

</html>